@page "/edit-project"
@page "/edit-project/{Id:int}"
@inject NavigationManager NavigationManager
@inject EnvironmentVariableService EnvironmentVariableService
@rendermode InteractiveServer

@if(Id is null)
{
	<PageTitle>Add a new project</PageTitle>
	<h3>Add a new project</h3>
}
else
{
	<PageTitle>Edit: "@CurrentProject.Title"</PageTitle>
	<h3>Edit: "@CurrentProject.Title"</h3>
}

<EditForm Model="CurrentProject" OnSubmit="HandleSubmit">
	<div>
		<label for="title">Title</label>
		<InputText id="title" @bind-Value="CurrentProject.Title" class="form-control" />
	</div>
	<div>
		<label for="description">Description</label>
		<InputText id="description" @bind-Value="CurrentProject.Description" class="form-control" />
	</div>
	<div>
		<label for="weburl">WebUrl</label>
		<InputText id="weburl" @bind-Value="CurrentProject.WebUrl" class="form-control" />
	</div>
	<button type="submit" class="btn btn-primary">Save</button>
</EditForm>

@code
{
	[Parameter]
	public int? Id { get; set; }

	public PortfolioProject CurrentProject { get; set; } = new();
	private HttpResponseMessage response = new();

	protected override async Task OnParametersSetAsync()
	{
		if(Id is not null)
		{
			/*var project = await PortfolioService.GetProjectByIdAsync((int)Id);*/

			var APIURL = EnvironmentVariableService.GetApiUrl();
			HttpClient httpClient = new HttpClient();
			response = await httpClient.GetAsync(APIURL + "api/PortfolioOverview/" + (int)Id);
			var project = JsonConvert.DeserializeObject<PortfolioProject>(await response.Content.ReadAsStringAsync()) ?? new PortfolioProject();
			httpClient.Dispose();

			if(project is not null)
			{
				CurrentProject = project;
			}
		}
	}

	async Task HandleSubmit()
	{
		if(Id is not null)
		{
			// Update
			/*await PortfolioService.UpdateProjectAsync(CurrentProject, (int)Id);
			NavigationManager.NavigateTo("/portfolio");*/

			var APIURL = EnvironmentVariableService.GetApiUrl();

			HttpClient httpClient = new HttpClient();
			string jsonContent = JsonConvert.SerializeObject(CurrentProject);
			HttpContent httpContent = new StringContent(jsonContent);
			response = await httpClient.PutAsync(APIURL + "api/PortfolioProjects/" + (int)Id, httpContent);
			httpClient.Dispose();

			NavigationManager.NavigateTo("/portfolio");
		}
		else
		{
			// Add
			/*await PortfolioService.AddProjectAsync(CurrentProject);
			NavigationManager.NavigateTo("/portfolio");*/

			var APIURL = EnvironmentVariableService.GetApiUrl();

			HttpClient httpClient = new HttpClient();
			string jsonContent = JsonConvert.SerializeObject(CurrentProject);
			HttpContent httpContent = new StringContent(jsonContent);
			response = await httpClient.PostAsync(APIURL + "api/PortfolioProjects/", httpContent);
			httpClient.Dispose();

			NavigationManager.NavigateTo("/portfolio");

			NavigationManager.NavigateTo("/portfolio");
		}
	}
}
